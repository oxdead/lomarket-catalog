{{ header }}
<div id="checkout-checkout" class="container">
    <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
    </ul>
    
    <div id="content" class="{{ class }}">
        <h1>{{ heading_title }}</h1>

        <div class="panel-group">
            
            <h4>{{ text_checkout_payment_address }}</h4>
            <div id="guest-payment-address-body">
            </div>
            <hr>

            {% if shipping_required %}
            <h4>{{ text_checkout_shipping_address }}</h4>
            <div id="guest-shipping-address-body">
            </div>
            <hr>
            <h4>{{ text_checkout_shipping_method }}</h4>
            <div id="guest-shipping-method-body">
            </div>
            {% endif %}
            <hr>

            <h4>{{ text_checkout_payment_method }}</h4>
            <div id="guest-payment-method-body">
            </div>
            <hr>
            <div class="row">
                <button id="button-checkout-calculate">{{text_checkout_submit}}</button>
            </div>
            <hr>

            <h4>{{ text_checkout_confirm }}</h4>
            <div id="guest-checkout-confirm-body">
            </div>

        </div>
    </div>
    
</div>


<script src="catalog/view/javascript/checkout-guest.js" type="text/javascript"></script>






<script type="text/javascript"><!--


const c = {
    emitWarning: function(selector, msg){
        $(selector.body).prepend('<div class="alert alert-warning alert-dismissible">' + msg + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
    },
    emitError: function(selector, msg) {
        $(selector.body).prepend('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + msg + '<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
    },
    addErrorElement: function(elmPrefix, msg){
        for (i in msg) {
            var element = $(elmPrefix + i.replace('_', '-')); 

            if ($(element).parent().hasClass('input-group')) {
                $(element).parent().after('<div class="text-danger">' + msg[i] + '</div>');
            } else {
                $(element).after('<div class="text-danger">' + msg[i] + '</div>');
            }
        }
    },
    ajaxBodyUpdate: function(collapseKey, btnE = null){
        var selfKey = this[collapseKey];
        return $.ajax({
            url: selfKey.url,
            dataType: 'html',
            async: false,
            success: function(html) {
                //console.log(selfKey.url);
                $(selfKey.body).html(html);
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
    },
    "guestPaymentAddress":      {"url":"index.php?route=checkout/easy_guest_payment_address", "body":"#guest-payment-address-body"},
    "guestShippingAddress":     {"url":"index.php?route=checkout/easy_guest_shipping_address", "body":"#guest-shipping-address-body"},
    "guestShippingMethod":      {"url":"index.php?route=checkout/easy_guest_shipping_method", "body":"#guest-shipping-method-body"},
    "guestPaymentMethod":       {"url":"index.php?route=checkout/easy_guest_payment_method", "body":"#guest-payment-method-body"},
    "guestCheckoutConfirm":     {"url":"index.php?route=checkout/easy_guest_checkout_confirm", "body":"#guest-checkout-confirm-body"}
}






$(document).ready(function() {
    (async function() {
	    await guestPaymentAddress(); // guestCheckout previously
        guest_OnCountryChange('#guest-payment-address-body');
        
        {% if shipping_required %}
        await guestShippingAddress();
        guest_OnCountryChange('#guest-shipping-address-body');
        await guestShippingMethod();
        {% endif %}
        
        await guestPaymentMethod();
        guest_OnTermsAgree();
    })();
});


function guestPaymentAddress() {
    return $.ajax({
        url: 'index.php?route=checkout/easy_guest_payment_address',
        dataType: 'html',
        async: false,
        success: function(html) {
            //console.log("easy_guest_payment_address");
            // $('.alert-dismissible, .text-danger').remove();
			// $('.form-group').removeClass('has-error');

            $(c.guestPaymentAddress.body).html(html);
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}

function guestShippingAddress() {
    return $.ajax({
        url: 'index.php?route=checkout/easy_guest_shipping_address',
        dataType: 'html',
        async: false,
        success: function(html) {
            //console.log("easy_guest_shipping_address");
            // $('.alert-dismissible, .text-danger').remove();
			// $('.form-group').removeClass('has-error');

            $(c.guestShippingAddress.body).html(html);
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}

function guestShippingMethod() {
    return $.ajax({
        url: 'index.php?route=checkout/easy_guest_shipping_method',
        dataType: 'html',
        async: false,
        success: function(html) {
            //console.log("easy_guest_shipping_method");

            $(c.guestShippingMethod.body).html(html);
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}


function guestPaymentMethod() {
    return $.ajax({
        url: 'index.php?route=checkout/easy_guest_payment_method',
        dataType: 'html',
        async: false,
        success: function(html) {
            //console.log("easy_guest_payment_method");

            $(c.guestPaymentMethod.body).html(html);
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}


function guestPaymentAddressSave() {  
    return $.ajax({
        url: 'index.php?route=checkout/easy_guest_payment_address/save',
        type: 'post',
        data: $('#guest-payment-address-body input[type=\'text\'], #guest-payment-address-body input[type=\'date\'], #guest-payment-address-body input[type=\'datetime-local\'], #guest-payment-address-body input[type=\'time\'], #guest-payment-address-body input[type=\'checkbox\']:checked, #guest-payment-address-body input[type=\'radio\']:checked, #guest-payment-address-body input[type=\'hidden\'], #guest-payment-address-body textarea, #guest-payment-address-body select'),
        dataType: 'json',
        async: false,
        success: function(json) {
            console.log("easy_guest_payment_address/save");
            console.log(json);
            $('.alert-dismissible, .text-danger').remove();
			$('.form-group').removeClass('has-error');

            if (json['redirect']) {
                location = json['redirect'];
            } else if (json['error']) {
                if (json['error']['warning']) {
                    c.emitWarning(c.paymentAddress, json['error']['warning']);
                }
                c.addErrorElement('#input-payment-', json['error']);
				// Highlight any found errors
				$('.text-danger').parent().addClass('has-error');
            }
            // else {
            //     {% if shipping_required %}
            //     var shipping_address = $('#guest-payment-address-body input[name=\'shipping_address\']:checked').prop('value');

            //     if (shipping_address) {
            //         //update Shipping method and then guestShipping address
            //     } else {
            //         //update guestShipping address
            //     }
            //     {% endif %}
            // }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
}




$(document).delegate('#button-checkout-calculate', 'click', function() {

    //todo:
        // beforeSend: function() {
        // 	$('#button-account').button('loading');
		// },
        // complete: function() {
		// 	$('#button-account').button('reset');
        // },

    
    guestPaymentAddressSave().then(function(){
        // guestShippingAddressSave().then(function(){
        //     guestShippingMethodSave().then(function(){
        //         guestPaymentMethodSave().then(function(){
        //             c.ajaxBodyUpdate('guestCheckoutConfirm');
        //         });
        //     });
        // });
    });
});



//-->
</script> 





<script type="text/javascript"><!--
// function guestPaymentAddress() {  
//     return $.ajax({
//         url: 'index.php?route=checkout/guest/save',
//         type: 'post',
//         data: $('#collapse-payment-address input[type=\'text\'], #collapse-payment-address input[type=\'date\'], #collapse-payment-address input[type=\'datetime-local\'], #collapse-payment-address input[type=\'time\'], #collapse-payment-address input[type=\'checkbox\']:checked, #collapse-payment-address input[type=\'radio\']:checked, #collapse-payment-address input[type=\'hidden\'], #collapse-payment-address textarea, #collapse-payment-address select'),
//         dataType: 'json',
//         async: false,
//         success: function(json) {
//             //console.log("checkout/guest/save [guestPaymentAddress()]");
//             $('.alert-dismissible, .text-danger').remove();
// 			$('.form-group').removeClass('has-error');

//             if (json['redirect']) {
//                 location = json['redirect'];
//             } else if (json['error']) {
//                 if (json['error']['warning']) {
//                     c.emitWarning(c.paymentAddress, json['error']['warning']);
//                 }
//                 c.addErrorElement('#input-payment-', json['error']);
// 				// Highlight any found errors
// 				$('.text-danger').parent().addClass('has-error');
//             } else {
//                 {% if shipping_required %}
//                 var shipping_address = $('#collapse-payment-address input[name=\'shipping_address\']:checked').prop('value');

//                 if (shipping_address) {
//                     $.ajax({
//                         url: 'index.php?route=checkout/shipping_method',
//                         dataType: 'html',
//                         async: false,
//                         success: function(html) {
//                             //console.log("shipping_method [guestPaymentAddress(shipping_req+ship_address_req)]");
							
//                             c.ajaxBodyUpdate('guestShipping'); // Add the shipping address

// 						    $('#collapse-shipping-method .panel-body').html(html);
//                         },
//                         error: function(xhr, ajaxOptions, thrownError) {
//                             alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
//                         }
//                     });
//                 } else {
//                     c.ajaxBodyUpdate('guestShipping');
//                 }
//                 {% else %}
//                 c.ajaxBodyUpdate('paymentMethod');
//                 {% endif %}
//             }
//         },
//         error: function(xhr, ajaxOptions, thrownError) {
//             alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
//         }
//     });
// }


// function guestShippingAddress() {
//     return $.ajax({
//         url: 'index.php?route=checkout/guest_shipping/save',
//         type: 'post',
//         data: $('#collapse-shipping-address input[type=\'text\'], #collapse-shipping-address input[type=\'date\'], #collapse-shipping-address input[type=\'datetime-local\'], #collapse-shipping-address input[type=\'time\'], #collapse-shipping-address input[type=\'password\'], #collapse-shipping-address input[type=\'checkbox\']:checked, #collapse-shipping-address input[type=\'radio\']:checked, #collapse-shipping-address textarea, #collapse-shipping-address select'),
//         dataType: 'json',
//         async: false,
//         success: function(json) {
//             //console.log("guest_shipping/save [guestShippingAddress()]");
//             $('.alert-dismissible, .text-danger').remove();
//             $('.form-group').removeClass('has-error');

//             if (json['redirect']) {
//                 location = json['redirect'];
//             } else if (json['error']) {
//                 if (json['error']['warning']) {
//                     c.emitError(c.shippingAddress, json['error']['warning']);
//                 }
//                 c.addErrorElement('#input-shipping-', json['error']);
//                 // Highlight any found errors
//                 $('.text-danger').parent().addClass('has-error');
//             } else {
//                 c.ajaxBodyUpdate('shippingMethod');
//             }
//         },
//         error: function(xhr, ajaxOptions, thrownError) {
//             alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
//         }
//     });
// }


// function shippingMethod() {
//     return $.ajax({
//         url: 'index.php?route=checkout/shipping_method/save',
//         type: 'post',
//         data: $('#collapse-shipping-method input[type=\'radio\']:checked, #collapse-shipping-method textarea'),
//         dataType: 'json',
//         async: false,
//         success: function(json) {
//             //console.log("shipping_method/save [shippingMethod()]");
//             $('.alert-dismissible, .text-danger').remove();

//             if (json['redirect']) {
//                 location = json['redirect'];
//             } else if (json['error']) {
//                 if (json['error']['warning']) {
//                     c.emitError(c.shippingMethod, json['error']['warning']);
//                 }
//             } else {
//                 c.ajaxBodyUpdate('paymentMethod');
//             }
//         },
//         error: function(xhr, ajaxOptions, thrownError) {
//             alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
//         }
//     });
// }





// function paymentMethod() {
//     return $.ajax({
//         url: 'index.php?route=checkout/payment_method/save',
//         type: 'post',
//         data: $('#collapse-payment-method input[type=\'radio\']:checked, #collapse-payment-method input[type=\'checkbox\']:checked, #collapse-payment-method textarea'),
//         dataType: 'json',
//         async: false,
//         success: function(json) {
//             //console.log("payment_method/save [paymentMethod()]");
//             console.log(json);
//             $('.alert-dismissible, .text-danger').remove();

//             if (json['redirect']) {
//                 location = json['redirect'];
//             } else if (json['error']) {
//                 if (json['error']['warning']) {
//                     c.emitError(c.paymentMethod, json['error']['warning']);
//                 }
//             } else {
//                 c.ajaxBodyUpdate('confirm');
//             }
//         },
//         error: function(xhr, ajaxOptions, thrownError) {
//             alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
//         }
//     });
// }
    



//--></script> 
{{ footer }}